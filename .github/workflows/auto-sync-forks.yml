name: Auto Sync Forks (With Failure Reasons)

on:
  schedule:
    - cron: '0 * * * *' # æ¯å°æ—¶æ‰§è¡Œ
  workflow_dispatch:    # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  sync-and-log:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Sync Forks & Report Failures
        shell: pwsh
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT }}
        run: |
          # =======================================================
          #  åµŒå…¥å¼ PowerShell è„šæœ¬ (å«é”™è¯¯åŸå› è®°å½•)
          # =======================================================
          
          # --- 1. åˆå§‹åŒ–è®¾ç½® ---
          $LogFile = "README.md"
          $KeepDays = 7
          # åŒ—äº¬æ—¶é—´ (UTC + 8)
          $BeijingTime = [DateTime]::UtcNow.AddHours(8)
          $DateStr = $BeijingTime.ToString("yyyy-MM-dd HH:mm")
          $DateHeaderRegex = "## ğŸ“… (\d{4}-\d{2}-\d{2} \d{2}:\d{2})"
          
          # --- 2. æ£€æŸ¥ Token ---
          $Token = $env:GITHUB_TOKEN
          if ([string]::IsNullOrWhiteSpace($Token)) {
              Write-Error "âŒ é”™è¯¯: æœªæ£€æµ‹åˆ° GITHUB_TOKENï¼Œè¯·æ£€æŸ¥ä»“åº“ Secrets è®¾ç½®ã€‚"
              exit 1
          }
          
          $Headers = @{
              "Authorization" = "token $Token"
              "Accept"        = "application/vnd.github+json"
              "X-GitHub-Api-Version" = "2022-11-28"
          }
          $BaseUri = "https://api.github.com"

          # --- 3. è·å–æ‰€æœ‰ Fork ä»“åº“ ---
          Write-Host ">>> æ­£åœ¨æ‰«æä»“åº“åˆ—è¡¨..."
          $AllRepos = @()
          $Page = 1
          do {
              $Uri = "$BaseUri/user/repos?type=owner&per_page=100&page=$Page"
              try {
                  $Response = Invoke-RestMethod -Uri $Uri -Headers $Headers -Method Get
                  if ($Response.Count -gt 0) { $AllRepos += $Response; $Page++ }
              } catch { Write-Error "API è¯·æ±‚å¤±è´¥: $($_.Exception.Message)"; exit 1 }
          } while ($Response.Count -eq 100)

          $Forks = $AllRepos | Where-Object { $_.fork -eq $true -and $_.archived -eq $false }
          Write-Host ">>> å‘ç° $($Forks.Count) ä¸ªæ´»è·ƒçš„ Fork ä»“åº“ã€‚"

          # --- 4. å¾ªç¯åŒæ­¥å¹¶æ•è·åŸå›  ---
          $LogEntries = @() # ç”¨äºå­˜æ”¾æœ¬æ¬¡å†™å…¥æ—¥å¿—çš„æ¡ç›®
          
          foreach ($repo in $Forks) {
              $RepoName = $repo.full_name
              Write-Host ">>> æ­£åœ¨åŒæ­¥ä»“åº“: $RepoName"

              # è·å–ä»“åº“çš„æ‰€æœ‰åˆ†æ”¯
              $BranchesUri = "$BaseUri/repos/$RepoName/branches"
              try {
                  $Branches = Invoke-RestMethod -Uri $BranchesUri -Headers $Headers -Method Get
              } catch {
                  Write-Error "è·å–åˆ†æ”¯å¤±è´¥: $($_.Exception.Message)"
                  continue
              }

              # å¯¹æ¯ä¸ªåˆ†æ”¯è¿›è¡ŒåŒæ­¥
              foreach ($branch in $Branches) {
                  $BranchName = $branch.name
                  $SyncUri = "$BaseUri/repos/$RepoName/merge-upstream"
                  $Body = @{ branch = $BranchName } | ConvertTo-Json -Compress
                  
                  # æ§åˆ¶å°æ˜¾ç¤ºè¿›åº¦
                  Write-Host "Checking: $RepoName ($BranchName)" -NoNewline

                  try {
                      $SyncResponse = Invoke-RestMethod -Uri $SyncUri -Headers $Headers -Method Post -Body $Body -ErrorAction Stop
                      
                      if ($SyncResponse.message -match "Successfully fetched" -or $SyncResponse.merge_type -eq "fast-forward") {
                          Write-Host " -> [æˆåŠŸæ›´æ–°]" -ForegroundColor Green
                          # æ·»åŠ åˆ°æ—¥å¿—ï¼Œä»“åº“åä½œä¸ºè¶…é“¾æ¥
                          $LogEntries += "âœ… [**$RepoName**](https://github.com/$RepoName) ($BranchName): åŒæ­¥æˆåŠŸ"
                      } else {
                          Write-Host " -> [çŠ¶æ€: $($SyncResponse.message)]" -ForegroundColor Yellow
                      }
                  }
                  catch {
                      # è·å–é”™è¯¯è¯¦æƒ…
                      $Ex = $_.Exception
                      $StatusCode = 0
                      $ErrorMsg = "æœªçŸ¥é”™è¯¯"
                      
                      if ($Ex.Response) {
                          $StatusCode = $Ex.Response.StatusCode.value__
                      }
                      
                      # å°è¯•ä» GitHub è¿”å›çš„ JSON ä¸­è¯»å–é”™è¯¯ä¿¡æ¯
                      try {
                          $JsonStream = $Ex.Response.GetResponseStream()
                          $Reader = New-Object System.IO.StreamReader($JsonStream)
                          $JsonStr = $Reader.ReadToEnd()
                          $ErrorDetails = $JsonStr | ConvertFrom-Json
                          if ($ErrorDetails.message) { $ErrorMsg = $ErrorDetails.message }
                      } catch {
                          $ErrorMsg = $Ex.Message
                      }

                      # --- æ ¹æ®é”™è¯¯ç±»å‹å†³å®šæ˜¯å¦è®°å½•åˆ°æ—¥å¿— ---
                      
                      if ($StatusCode -eq 409) {
                          if ($ErrorMsg -match "Branch is not behind") {
                              # æƒ…å†µA: å·²ç»æ˜¯æœ€æ–° -> æ§åˆ¶å°æ‰“å°ç°è‰²ï¼Œä½†ä¸å†™å…¥æ—¥å¿—ï¼ˆé˜²åˆ·å±ï¼‰
                              Write-Host " -> [æ— éœ€æ›´æ–°]" -ForegroundColor Gray
                          } else {
                              # æƒ…å†µB: å†²çª -> å¿…é¡»è®°å½•ï¼
                              Write-Host " -> [ä»£ç å†²çª]" -ForegroundColor Red
                              $LogEntries += "âš ï¸ [**$RepoName**](https://github.com/$RepoName) ($BranchName): åŒæ­¥å¤±è´¥ - **ä»£ç å†²çª** (æ— æ³•è‡ªåŠ¨åˆå¹¶ï¼Œè¯·æ‰‹åŠ¨è§£å†³)"
                          }
                      }
                      elseif ($StatusCode -eq 404) {
                          # æƒ…å†µC: ä¸Šæ¸¸æ²¡äº†
                          Write-Host " -> [ä¸Šæ¸¸ä¸¢å¤±]" -ForegroundColor Red
                          $LogEntries += "âŒ [**$RepoName**](https://github.com/$RepoName) ($BranchName): åŒæ­¥å¤±è´¥ - **ä¸Šæ¸¸ä»“åº“ä¸å­˜åœ¨** (å¯èƒ½å·²è¢«åŸä½œè€…åˆ é™¤)"
                      }
                      elseif ($StatusCode -eq 422) {
                          # æƒ…å†µD: æ— æ³•å¤„ç† (å¦‚å†å²è®°å½•ä¸ç›¸å…³)
                          Write-Host " -> [æ— æ³•å¤„ç†]" -ForegroundColor Red
                          $LogEntries += "âŒ [**$RepoName**](https://github.com/$RepoName) ($BranchName): åŒæ­¥å¤±è´¥ - **æ— æ³•åˆå¹¶** (å†å²è®°å½•ä¸ç›¸å…³/Git é”™è¯¯)"
                      }
                      else {
                          # æƒ…å†µE: å…¶ä»–é”™è¯¯
                          Write-Host " -> [é”™è¯¯ $StatusCode]" -ForegroundColor Red
                          $LogEntries += "âŒ [**$RepoName**](https://github.com/$RepoName) ($BranchName): åŒæ­¥å¤±è´¥ - HTTP $StatusCode ($ErrorMsg)"
                      }
                  }
                  Start-Sleep -Milliseconds 100 # é˜²é™æµ
              }
          }

          # --- 5. ç”Ÿæˆå¹¶å†™å…¥æ—¥å¿— ---
          
          # è¯»å–æ—§å†…å®¹
          $CurrentContent = ""
          if (Test-Path $LogFile) { $CurrentContent = Get-Content $LogFile -Raw -Encoding utf8 }
          
          # åªæœ‰å½“ $LogEntries ä¸ä¸ºç©ºæ—¶ï¼ˆæœ‰æˆåŠŸæ›´æ–° æˆ– æœ‰é”™è¯¯/å†²çªï¼‰æ‰å†™å…¥
          if ($LogEntries.Count -gt 0) {
              Write-Host "`n>>> æ­£åœ¨æ›´æ–°æ—¥å¿—æ–‡ä»¶..."
              
              $NewBlock = "## ğŸ“… $DateStr (åŒ—äº¬æ—¶é—´)`n`n"
              foreach ($item in $LogEntries) { $NewBlock += "- $item`n" }
              $NewBlock += "`n"

              # æ‹¼æ¥å†…å®¹
              $Header = "# åŒæ­¥æ—¥å¿—`n`næ­¤æ–‡ä»¶ç”± GitHub Actions è‡ªåŠ¨ç”Ÿæˆï¼Œä»…ä¿ç•™æœ€è¿‘ $KeepDays å¤©è®°å½•ã€‚`n`n"
              $BodyOnly = $CurrentContent -replace "^# åŒæ­¥æ—¥å¿—.*?\n\n", ""
              $FullContent = $Header + $NewBlock + $BodyOnly
              
              # æ¸…ç†è¿‡æœŸæ—¥å¿—
              $Blocks = $FullContent -split "(?=## ğŸ“…)"
              $FilteredBlocks = @()
              $CutoffDate = $BeijingTime.AddDays(-$KeepDays)

              foreach ($block in $Blocks) {
                  if ($block -match $DateHeaderRegex) {
                      try {
                          $BlockDate = [DateTime]::ParseExact($Matches[1], "yyyy-MM-dd HH:mm", $null)
                          if ($BlockDate -ge $CutoffDate) { $FilteredBlocks += $block }
                      } catch { $FilteredBlocks += $block }
                  } else {
                      $FilteredBlocks += $block 
                  }
              }
              
              $FinalContent = $FilteredBlocks -join ""
              Set-Content -Path $LogFile -Value $FinalContent -Encoding utf8
          } else {
              Write-Host "`n>>> æ‰€æœ‰ä»“åº“å‡ä¸ºæœ€æ–°çŠ¶æ€ï¼Œæ— å˜åŒ–éœ€è¦è®°å½•ã€‚"
          }

      - name: Commit and Push
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"
          
          if [[ -n $(git status -s README.md) ]]; then
            git add README.md
            git commit -m "docs: update sync log with status [skip ci]"
            git push
            echo "âœ… æ—¥å¿—å·²æ›´æ–°å¹¶æ¨é€ã€‚"
          else
            echo "âœ… æ—¥å¿—æ— å˜åŒ–ã€‚"
          fi
